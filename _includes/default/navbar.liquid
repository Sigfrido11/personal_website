<header class="site-header">

    <div class="visit-counter" aria-live="polite">
      Visite: <strong id="visit-count">â€”</strong>
    </div>

    <!-- Logo and title -->
	<div class="branding">
        {% if site.avatar %}
		<a href="{{ '/' | relative_url }}">
			<img alt="logo img" class="avatar" src="{{ site.avatar | relative_url }}" loading="lazy"/>
		</a>
        {% endif %}
        <a class="site-title" aria-label="{{ site.title }}" href="{{ '/' | relative_url }}">
        {{ site.title }}
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    {% assign is_en_page = false %}
    {% if page.lang == 'en' %}
      {% assign is_en_page = true %}
    {% elsif page.url %}
      {% if page.url == '/en' or page.url == '/en/' or page.url contains '/en/' %}
        {% assign is_en_page = true %}
      {% endif %}
    {% endif %}
    {% assign nav_lang = 'it' %}
    {% if is_en_page %}
      {% assign nav_lang = 'en' %}
    {% endif %}

    <ul class="hide">
        {% assign name_page = "" %}
        {% assign emptyArray = '' | split: '' %}
        {% assign menus = site.data.menu | default: emptyArray %}
        {% assign nav_pages = site.pages | concat: menus | sort: 'position' %}
        {% for nav_page in nav_pages %}
        {% unless nav_page.title == null or nav_page.hide or name_page contains nav_page.title or nav_page.title == site.title or (nav_page.lang and nav_page.lang != nav_lang) %}
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="{{ nav_page.title }}" title="{{ nav_page.title }}" href="{{ nav_page.url | relative_url }}" data-set-lang="{{ nav_lang }}">
                    {% if nav_page.icon %} <i class="navbar-icon fas {{ nav_page.icon }}" aria-hidden="true"></i>{% endif %}
                    <span class="navbar-label {% if nav_page.icon %}navbar-label-with-icon{% endif%}" data-i18n-key="{{ nav_page.url }}" data-i18n-original="{{ nav_page.title }}">{{ nav_page.title }}</span>
                </a>
            </li>
        {% endunless %}
        {% assign name_page = nav_page.title | append: name_page %}
        {% endfor %}

        {% assign lang_switch_url = '/en/' | relative_url %}
        {% assign lang_switch_label = 'EN' %}
        {% if is_en_page %}
          {% assign lang_switch_url = '/' | relative_url %}
          {% assign lang_switch_label = 'IT' %}
        {% endif %}
        {% if page.lang_ref %}
          {% assign translation_it = site.posts | where: "lang_ref", page.lang_ref | where: "lang", "it" | first %}
          {% assign translation_en = site.posts | where: "lang_ref", page.lang_ref | where: "lang", "en" | first %}
          {% if page.lang == 'it' and translation_en %}
            {% assign lang_switch_url = translation_en.url | relative_url %}
          {% elsif page.lang == 'en' and translation_it %}
            {% assign lang_switch_url = translation_it.url | relative_url %}
          {% endif %}
        {% endif %}

        <li class="separator"> | </li>
        <li><a id="lang-toggle" title="Switch language" aria-label="Switch language" href="{{ lang_switch_url }}" onclick="toggleLanguage(event)">{{ lang_switch_label }}</a></li>

        {% if site.color_theme == 'auto' %}
        <li class="separator"> | </li>
        <li><a id="theme-toggle" title="{{ page.title }} " aria-label="{{ page.title }}" onclick="themeToggle()"></a></li>
        {% endif %}
    </ul>

	</nav>
</header>

<script>
  (function () {
    const lightSrc = "{{ '/assets/img/home_bkbk.png' | relative_url }}";
    const darkSrc  = "{{ '/assets/img/home_whbk.png'  | relative_url }}";
    const avatarSelector = '.avatar';

    function setAvatar() {
      const img = document.querySelector(avatarSelector);
      if (!img) return;
      const theme = document.documentElement.getAttribute('data-theme') || 'light';
      img.src = theme === 'dark' ? darkSrc : lightSrc;
    }

    // Hook themeToggle if present
    if (window.themeToggle) {
      const original = window.themeToggle;
      window.themeToggle = function () {
        original();
        setAvatar();
      };
    }

    document.addEventListener('DOMContentLoaded', setAvatar);
  })();

  (function () {
    const counterEl = document.getElementById('visit-count');
    if (!counterEl) return;
    const isLocal = ['localhost', '127.0.0.1'].includes(location.hostname);
    if (isLocal) {
      counterEl.textContent = '123'; // placeholder when developing locally
      return;
    }
    const endpoint = 'https://api.countapi.xyz/hit/sigfrido11/visite';
    fetch(endpoint)
      .then(r => r.json())
      .then(data => {
        if (data && data.value !== undefined) {
          counterEl.textContent = data.value.toLocaleString('it-IT');
        } else {
          counterEl.textContent = '0';
        }
      })
      .catch(() => { counterEl.textContent = '0'; });
  })();

  // Ensure language toggle text and handler are set even if head script is cached/blocked
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('lang-toggle');
    if (!toggle) return;
    if (!toggle.textContent.trim()) {
      const saved = (typeof window.getStoredLanguage === 'function')
        ? window.getStoredLanguage()
        : (localStorage.getItem('site-language') || ((navigator.language || 'en').toLowerCase().startsWith('it') ? 'it' : 'en'));
      toggle.textContent = saved === 'it' ? 'EN' : 'IT';
    }
    // Click handler is inline to ensure navigation always works.
  });
</script>
