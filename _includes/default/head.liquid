<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    <!-- Theme Mode-->
    <script>
        const darkBtn = "{{ site.data.language.str_dark | default: "Dark" }}";
        const lightBtn = "{{ site.data.language.str_light | default: "Light" }}";
        const isAutoTheme = {% if site.color_theme == 'auto' %}true{% else %}false{% endif %};
        const preferredTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        if (isAutoTheme) {
            document.documentElement.setAttribute('data-theme', sessionStorage.getItem('theme') ?? preferredTheme);
        } else {
            document.documentElement.setAttribute('data-theme', "{{ site.color_theme | default: 'light' }}");
        }
    </script>
    <script>
        const i18nMenu = {
            en: {
                "/about/": "About",
                "/archive/": "Blog Archive",
                "/categories/": "Categories",
                "/gallery/": "Gallery",
                "/portfolio/": "Portfolio",
                "/search/": "Search",
                "/tags/": "Tags"
            },
            it: {
                "/about/": "Chi sono?",
                "/archive/": "Archivio",
                "/categories/": "Categorie",
                "/gallery/": "Galleria",
                "/portfolio/": "Portfolio",
                "/search/": "Cerca",
                "/tags/": "Tag"
            }
        };

        function getStoredLanguage() {
            const saved = localStorage.getItem('site-language');
            if (saved === 'it' || saved === 'en') return saved;
            return navigator.language && navigator.language.toLowerCase().startsWith('it') ? 'it' : 'en';
        }

        function getPageLanguage() {
            const meta = document.querySelector('meta[name="page-lang"]');
            const lang = meta ? meta.getAttribute('content') : null;
            if (lang === 'it' || lang === 'en') return lang;
            const base = "{{ '/' | relative_url }}";
            const baseTrimmed = base.endsWith('/') ? base.slice(0, -1) : base;
            let path = window.location.pathname;
            if (baseTrimmed && path.startsWith(baseTrimmed)) {
                path = path.slice(baseTrimmed.length);
            }
            if (path === '/en' || path.startsWith('/en/')) return 'en';
            return null;
        }

        function updateLanguageCollections(lang) {
            document.querySelectorAll('[data-lang-filter]').forEach((item) => {
                const itemLang = item.getAttribute('data-lang-filter');
                const shouldShow = !itemLang || itemLang === lang;
                item.classList.toggle('lang-hidden', !shouldShow);
            });
        }

        function applyLanguage(lang) {
            const normalized = lang === 'it' ? 'it' : 'en';
            document.documentElement.setAttribute('lang', normalized);
            localStorage.setItem('site-language', normalized);

            document.querySelectorAll('.navbar-label[data-i18n-original]').forEach((item) => {
                const key = item.getAttribute('data-i18n-key') || item.getAttribute('data-i18n-original');
                const original = item.getAttribute('data-i18n-original') || item.textContent;
                const translation = (i18nMenu[normalized] && i18nMenu[normalized][key]) || null;
                item.textContent = translation || original;
            });

            // Toggle language panels across pages, fallback to first available if translation is missing
            const panels = Array.from(document.querySelectorAll('.lang-panel'));
            if (panels.length) {
              const target = panels.find((p) => p.dataset.lang === normalized);
              const show = target || panels[0];
              panels.forEach((panel) => panel.classList.toggle('active', panel === show));
            }

            updateLanguageCollections(normalized);

            const toggle = document.getElementById('lang-toggle');
            if (toggle) {
                const targetLang = normalized === 'it' ? 'en' : 'it';
                const targetUrl = getTranslationUrl(targetLang) || getBlogSwitchUrl(targetLang);
                const { baseWithSlash } = getBasePaths();
                const fallbackUrl = targetLang === 'en' ? (baseWithSlash + 'en/') : baseWithSlash;
                const newHref = targetUrl || fallbackUrl;
                if (newHref) {
                    toggle.setAttribute('href', newHref);
                }
                if (normalized === 'it') {
                    toggle.textContent = 'EN';
                    toggle.setAttribute('title', 'Switch to English');
                    toggle.setAttribute('aria-label', 'Switch to English');
                } else {
                    toggle.textContent = 'IT';
                    toggle.setAttribute('title', 'Passa a Italiano');
                    toggle.setAttribute('aria-label', 'Passa a Italiano');
                }
            }
        }

        function getTranslationUrl(lang) {
            const meta = document.querySelector(`meta[name="translation-${lang}"]`);
            return meta ? meta.getAttribute('content') : null;
        }

        function getBasePaths() {
            const base = "{{ '/' | relative_url }}";
            const baseWithSlash = base.endsWith('/') ? base : base + '/';
            const baseTrimmed = base.endsWith('/') ? base.slice(0, -1) : base;
            return { base, baseWithSlash, baseTrimmed };
        }

        function getBlogSwitchUrl(targetLang) {
            const { baseTrimmed, baseWithSlash } = getBasePaths();
            let relative = window.location.pathname;
            if (baseTrimmed && relative.startsWith(baseTrimmed)) {
                relative = relative.slice(baseTrimmed.length);
            }
            if (!relative.startsWith('/')) relative = '/' + relative;

            const isItHome = relative === '/' || relative === '';
            const isEnHome = relative === '/en' || relative === '/en/';
            const itPageMatch = relative.match(/^\/page\/(\d+)\/?$/) || relative.match(/^\/page(\d+)\/?$/);
            const enPageMatch = relative.match(/^\/en\/page\/(\d+)\/?$/) || relative.match(/^\/en\/page(\d+)\/?$/);

            if (targetLang === 'en') {
                if (isItHome) return baseWithSlash + 'en/';
                if (itPageMatch) {
                    const pageNum = itPageMatch[1];
                    return pageNum === '1' ? baseWithSlash + 'en/' : baseWithSlash + 'en/page/' + pageNum + '/';
                }
            } else {
                if (isEnHome) return baseWithSlash;
                if (enPageMatch) {
                    const pageNum = enPageMatch[1];
                    return pageNum === '1' ? baseWithSlash : baseWithSlash + 'page/' + pageNum + '/';
                }
            }
            return null;
        }

        function toggleLanguage(event) {
            if (event) event.preventDefault();
            const current = getPageLanguage() || localStorage.getItem('site-language') || getStoredLanguage();
            const targetLang = current === 'it' ? 'en' : 'it';
            applyLanguage(targetLang);
            const targetUrl = getTranslationUrl(targetLang) || getBlogSwitchUrl(targetLang);
            if (targetUrl && targetUrl !== window.location.pathname && targetUrl !== window.location.href) {
                window.location.href = targetUrl;
                return;
            }
            const toggle = document.getElementById('lang-toggle');
            const href = toggle ? toggle.getAttribute('href') : null;
            if (href && href !== '#' && href !== window.location.pathname && href !== window.location.href) {
                window.location.href = href;
                return;
            }
            const { baseWithSlash } = getBasePaths();
            const fallbackUrl = targetLang === 'en' ? (baseWithSlash + 'en/') : baseWithSlash;
            if (fallbackUrl && fallbackUrl !== window.location.pathname && fallbackUrl !== window.location.href) {
                window.location.href = fallbackUrl;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const pageLang = getPageLanguage();
            applyLanguage(pageLang || getStoredLanguage());
            document.querySelectorAll('[data-set-lang]').forEach((link) => {
                link.addEventListener('click', () => {
                    const target = link.getAttribute('data-set-lang');
                    if (target === 'it' || target === 'en') {
                        localStorage.setItem('site-language', target);
                    }
                });
            });
        });
    </script>

    {% if page.lang == "it" or page.lang == "en" %}
      <meta name="page-lang" content="{{ page.lang }}">
    {% endif %}
    {% if page.lang_ref %}
      {% assign translation_it = site.posts | where: "lang_ref", page.lang_ref | where: "lang", "it" | first %}
      {% assign translation_en = site.posts | where: "lang_ref", page.lang_ref | where: "lang", "en" | first %}
      {% if translation_it %}
      <meta name="translation-it" content="{{ translation_it.url | relative_url }}">
      {% endif %}
      {% if translation_en %}
      <meta name="translation-en" content="{{ translation_en.url | relative_url }}">
      {% endif %}
    {% endif %}

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="{{ '/assets/js/main.min.js' | relative_url }}"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">

    <!--Favicon-->
    <link rel="shortcut icon" href="{{ site.favicon | relative_url }}" type="image/x-icon">

    <!-- Preconnect to Cusdis for faster loading when comments become visible -->
    {% if site.data.comments.cusdis.app_id or site.comments.cusdis_app_id or site.cusdis_app_id %}
    <link rel="preconnect" href="https://cusdis.com">
    {% endif %}

    {% if page.bootstrap %}
    <!-- Bootstrap-4.1.3 isolation CSS -->
    <link rel="stylesheet" type="text/css" href="{{ '/assets/css/vendor/bootstrap-iso.min.css' | relative_url }}">
    <!-- JQuery 3.3.1 -->
    <script defer src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <!-- Bootstrap 4.1.3 compiled and minified JavaScript -->
    <script defer src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <!-- Popper, a dependency of Bootstrap-->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    {% endif %}

    <!-- KaTeX 0.16.28 -->
    {% if site.katex or site.theme_settings.katex %}
    <script defer src="{{ '/assets/js/vendor/katex.min.js' | relative_url }}"></script>
    <script defer src="{{ '/assets/js/vendor/katex.auto-render.min.js' | relative_url }}" onload="renderMathInElement(document.body);"></script>
    {% endif %}

    <!-- Mermaid 11.12.2 -->
    {% if site.mermaid %}
    <script defer src="{{ '/assets/js/vendor/mermaid.min.js' | relative_url }}"></script>
    {% endif %}

    <!-- Simple Jekyll Search 2.1.1 -->
    <script src="{{ '/assets/js/vendor/simple-jekyll-search.min.js' | relative_url }}" type="text/javascript"></script>

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-{{ site.url }}';
      const isCookieConsent = '{{ site.cookie_consent }}';
      const analyticsName = '{{ site.google_analytics }}';
      const analyticsNameGA4 = '{{ site.google_analytics_ga4 }}';
    </script>

    {% if site.cookie_consent %}
        <span id="cookie-notice"><span>{{ site.data.language.str_cookie_disclaimer | default: "We would like to use third party cookies and scripts to improve the functionality of this website." }}
          </span><a id="cookie-notice-accept" class="button">{{ site.data.language.str_cookie_approve | default: "Approve" }}</a>
        </span>
    {% endif %}
    {% if site.google_analytics %}
        <!-- Global site tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics }}"></script>
    {% endif %}

    <!-- seo tags -->
    <meta property="og:image" content="{{ '/' | absolute_url }}{% if page.thumbnail %}{{ page.thumbnail }}{% else %}{{ page.feature-img | default: site.header_feature_image }}{% endif %}">
    {% unless page.layout == post %}
    <meta property="og:type" content="website" />
    {% endunless %}
    {% seo %}

    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="{{ site.title | default: 'Title' }}" href="{{ 'feed.xml' | absolute_url }}"/>
    {% feed_meta %}

    <!-- Inline lang switcher styles/scripts (lightweight, no extra assets) -->
    <style>
      .lang-switch {
        display: inline-flex;
        gap: 0.5rem;
        margin: 0 0 1rem;
        background: #f1f5f8;
        padding: 0.4rem;
        border-radius: 14px;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
      }
      .lang-btn {
        border: none;
        background: transparent;
        padding: 0.55rem 1.1rem;
        border-radius: 10px;
        font-weight: 600;
        color: #0b6fa4;
        cursor: pointer;
        transition: all 0.18s ease;
      }
      .lang-btn.active {
        background: linear-gradient(120deg, #0b6fa4, #00a67c);
        color: #fff;
        box-shadow: 0 10px 25px -12px rgba(0, 166, 124, 0.55);
      }
      .lang-panel { display: none; }
      .lang-panel.active { display: block; }
      .lang-hidden { display: none !important; }
      .post-lang-switch {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: space-between;
        margin: 0.25rem auto 1rem;
        padding: 4px;
        border-radius: 999px;
        background: #eef3f7;
        box-shadow: inset 0 0 0 1px rgba(11, 111, 164, 0.12);
        overflow: hidden;
        width: 7.4rem;
      }
      .post-lang-switch .lang-indicator {
        position: absolute;
        top: 4px;
        bottom: 4px;
        left: 4px;
        width: calc(50% - 4px);
        border-radius: 999px;
        background: linear-gradient(120deg, #0b6fa4, #00a67c);
        box-shadow: 0 12px 22px -12px rgba(0, 166, 124, 0.55);
        transition: transform 0.25s ease;
        z-index: 0;
      }
      .post-lang-switch.is-en .lang-indicator {
        transform: translateX(100%);
      }
      .post-lang-switch .lang-option {
        position: relative;
        z-index: 1;
        flex: 1 1 50%;
        text-align: center;
        padding: 0.35rem 0.6rem;
        font-weight: 700;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        color: #0b6fa4;
        text-decoration: none;
        transition: color 0.2s ease;
      }
      .post-lang-switch .lang-option.is-active {
        color: #fff;
        pointer-events: none;
      }
      .post-lang-switch .lang-option:not(.is-active):hover {
        color: #083f63;
      }
    </style>
    <script>
      (() => {
        function initSwitcher(container) {
          const panels = Array.from(container.parentElement.querySelectorAll('.lang-panel'));
          const buttons = Array.from(container.querySelectorAll('.lang-btn'));
          if (!panels.length || !buttons.length) return;
          const storageKey = 'lang-' + (container.dataset.langGroup || location.pathname);

          const showLang = (lang) => {
            panels.forEach((p) => p.classList.toggle('active', p.dataset.lang === lang));
            buttons.forEach((b) => b.classList.toggle('active', b.dataset.langTarget === lang));
            localStorage.setItem(storageKey, lang);
          };

          buttons.forEach((btn) => btn.addEventListener('click', () => showLang(btn.dataset.langTarget)));

          const saved = localStorage.getItem(storageKey);
          const browserLang = (navigator.language || 'it').slice(0, 2);
          const firstLang = buttons[0].dataset.langTarget;
          const initial = saved || (browserLang === 'en' ? 'en' : firstLang);
          showLang(initial);
        }

        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.lang-switch').forEach(initSwitcher);
        });
      })();
    </script>

    
</head>
